---
title: "Tvyal Newsletter"
author: "Aghasi Tavadyan"
date: "2024-06-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(rvest)
library(scales)
library(RcppRoll)

# rm(list = ls()); gc()

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

source("../../initial_setup.R")

```

```{r scraping data, include=FALSE}

arm_month_names <- c(
  "’Ä’∏÷Ç’∂’æ’°÷Ä", "’ì’•’ø÷Ä’æ’°÷Ä", "’Ñ’°÷Ä’ø", "‘±’∫÷Ä’´’¨", "’Ñ’°’µ’´’Ω", "’Ä’∏÷Ç’∂’´’Ω", "’Ä’∏÷Ç’¨’´’Ω",
  "’ï’£’∏’Ω’ø’∏’Ω", "’ç’•’∫’ø’•’¥’¢’•÷Ä", "’Ä’∏’Ø’ø’•’¥’¢’•÷Ä", "’Ü’∏’µ’•’¥’¢’•÷Ä", "‘¥’•’Ø’ø’•’¥’¢’•÷Ä"
)

xlsx_elements <- 
  read_html("https://minfin.am/hy/page/amsakan_vichakagrakan_teghekagrer/") |> 
  html_elements(".doc_title > a")

max_avalable_date_in_dbs <- 
  tibble(db_name =html_text(xlsx_elements)) |> 
  extract(
    db_name, into = c("year", "month_arm"), 
    regex = ".* (\\d{4}) ’©’æ’°’Ø’°’∂ ?\\(?([‘±-’ñ’°-÷Ü]*)?\\)?"
  ) |> 
  mutate(
    month_arm = ifelse(month_arm == "", "‘¥’•’Ø’ø’•’¥’¢’•÷Ä", month_arm),
    month = c(1:12)[match(month_arm, arm_month_names)],
    date = ym(paste(year, month)) + months(1) - days(1)
  ) |> 
  filter(date == max(date)) |> 
  pull(date)

```

```{r deciding to download data or not, include=FALSE}

dept_clean <-  
  read_csv("dept_clean.csv")

if (max_avalable_date_in_dbs != max(dept_clean$date)) {
  
  dept_dict <- read_csv("dept_dict.csv")
  
  initial_data <- 
    tibble(
      title = html_text(xlsx_elements),
      link = html_attr(xlsx_elements, "href")
    ) |> 
    mutate(
      data = map(link, ~rio::import(URLencode(.x), which = 1))
    )
  
  # the convoluted function below just adjusts 2 out-of-pace values in 2017 database
  dept_data_initial_setup <- function(tbl){
    
    rnumber_of_rows <- nrow(tbl)
    
    result_tbl <-
      tbl |> 
      rename(indicator = 1) |> 
      mutate(
        indicator = ifelse(
          lag(indicator) %in% c("’¥’¨÷Ä’§ ’§÷Ä’°’¥", "’¥’¨’∂ ‘±’Ñ’Ü ’§’∏’¨’°÷Ä") & is.na(indicator), 
          lag(indicator),
          indicator
        ),
        indicator = ifelse(is.na(indicator), "NA", indicator),
        indicator = ifelse(
          lead(indicator) != indicator | row_number() == rnumber_of_rows, 
          indicator,
          NA
        ),
        indicator = ifelse(indicator == "NA", NA, indicator)
      )
    
    return(result_tbl)
  }
  
  
  dept_data_get_colnames <- function(tbl){
    colnames <- 
      tbl |> 
      filter(indicator == "’¥’¨÷Ä’§ ’§÷Ä’°’¥") |> 
      mutate(indicator = "indicator")
    
    colnames <- unlist(colnames[1,], use.names = FALSE)
    
    return(colnames)
  }
  
  
  dept_data_manipulate <- function(tbl, colnames){
    
    FX_units <- c("’¥’¨÷Ä’§ ’§÷Ä’°’¥", "’¥’¨’∂ ‘±’Ñ’Ü ’§’∏’¨’°÷Ä")
    
    tbl_result <- 
      tbl |> 
      set_names(colnames) |> 
      mutate(
        unit_FX = ifelse(
          is.na(lag(indicator)) | grepl("’°’∂’æ’°’∂’°’Ø’°’∂ ’°÷Ä’™’•÷Ñ’∏’æ", lag(indicator)),
          indicator, 
          NA
        )
      ) |> 
      fill(unit_FX, .direction = "down") |> 
      filter(!indicator %in% FX_units, !is.na(indicator)) |> 
      pivot_longer(-c(indicator, unit_FX), names_to = "date") |> 
      mutate(
        value = parse_number(value),
        date = dmy(date)
      )
    
    return(tbl_result)
  }
  
  dept_clean <- 
    initial_data |> 
    # filter(!grepl("2017", title)) |> 
    mutate(
      data = map(data, dept_data_initial_setup),
      colnames = map(data, dept_data_get_colnames),
      data = map2(data, colnames, dept_data_manipulate)
    ) |> 
    select(-colnames) |> 
    unnest(data) |> 
    mutate(
      year = year(date),
      month = month(date),
      year_report = str_replace(title, ".*(\\d{4}).*", "\\1"),
      indicator = str_remove_all(indicator, "\\*")
    ) |> 
    filter(
      !is.na(value),
      year_report == year | year_report == 2017
    ) |> 
    unique() |> 
    left_join(dept_dict, by = join_by(unit_FX, indicator)) |> 
    select(date, year, month, unit_FX, indicator, code, value) |> 
    arrange(code, unit_FX, indicator, date)
  
  dept_clean |> 
     write_excel_csv("dept_clean.csv")
  
}

```

```{r dept plot 1, include=FALSE}

dept_plot_1 <- 
  dept_clean |> 
  filter(code %in% c("FX", "USD.", "AMD.")) |> 
  mutate(
    value = ifelse(code !=  "FX", value / 1000, value),
    unit_FX = case_when(
      unit_FX == "’¥’¨÷Ä’§ ’§÷Ä’°’¥" ~ "’ø÷Ä’´’¨’´’∏’∂ ’§÷Ä’°’¥",
      unit_FX == "’¥’¨’∂ ‘±’Ñ’Ü ’§’∏’¨’°÷Ä" ~ "’¥’¨÷Ä’§ ‘±’Ñ’Ü ’§’∏’¨’°÷Ä",
      TRUE ~ "‘±’Ñ’Ü ’§’∏’¨’°÷Ä / ’Ä’Ä ’§÷Ä’°’¥ ÷É’∏’≠’°÷Ä’™’•÷Ñ’®"
    ),
    unit_FX = fct_inorder(unit_FX)
  ) |> 
  ggplot(aes(date, value, color = unit_FX)) +
  geom_line(size = 1.2) +
  facet_grid(unit_FX~., scales = "free_y") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(
    label = function(x) {
      ifelse(
        x < 5, 
        scales::label_number(accuracy = 0.1)(x),
        scales::label_number(accuracy = 1)(x)
      )
    }
  ) +
  scale_color_manual(values = new_palette_colors[c(2,6,3)]) +
  labs(
    x = NULL,
    y = NULL,
    color = NULL,
    title = "’ä’•’ø’°’Ø’°’∂ ’∫’°÷Ä’ø÷Ñ’´ ’Ω’∫’°’Ω’°÷Ä’Ø’¥’°’∂ ÷á ÷É’∏’≠’°÷Ä’™’•÷Ñ’´ ÷É’∏’≠’Ø’°’∫’æ’°’Æ’∏÷Ç’©’µ’∏÷Ç’∂’®",
    subtitle = "‘¥÷Ä’°’¥’´ ’°÷Ä’™’•’¶÷Ä’Ø’¥’°’∂ ’∫’°÷Ä’°’£’°’µ’∏÷Ç’¥ ’§’∏’¨’°÷Ä’°’µ’´’∂ ’∫’•’ø’°’Ø’°’∂ ’∫’°÷Ä’ø÷Ñ’® ’¥’•’Æ’°’∂’°’¨’∏÷Ç ’ß",
    caption = caption_f("cba.am")
  ) +
  theme(
    legend.position = "none"
  )

```


```{r dept plot 2, include=FALSE}

dept_plot_2 <-
  dept_clean |> 
  filter(indicator %in% c(
    "’°÷Ä’ø’°÷Ñ’´’∂ ’∫’°÷Ä’ø÷Ñ", "’∂’•÷Ä÷Ñ’´’∂ ’∫’°÷Ä’ø÷Ñ" 
    # "’Ä’Ä ’Ø’•’∂’ø÷Ä’∏’∂’°’Ø’°’∂ ’¢’°’∂’Ø’´ ’°÷Ä’ø’°÷Ñ’´’∂ ’∫’°÷Ä’ø÷Ñ"
  )) |>
  group_by(date, unit_FX) |> 
  mutate(
    pct = value / sum(value, na.rm = TRUE)
  ) |> 
  group_by(year) |> 
  mutate(
    pct_text = percent(pct, accuracy = 0.1),
    value_text = number(value/1000, accuracy = 0.1),
    text = ifelse(
      month == max(month),
      paste0(value_text, "\n", pct_text),
      NA
    ),
  ) |>
  group_by(unit_FX, indicator) |> 
  mutate(
    text_correcton = ifelse(date == max(date), text, lead(text, 6)),
    text_correcton = ifelse(
      date == (max(date) + days(1) - months(6) - days(1)),
      NA, 
      text_correcton
    ),
    
    value = value / 1000,
    unit_FX = case_when(
      unit_FX == "’¥’¨÷Ä’§ ’§÷Ä’°’¥" ~ "’ø÷Ä’´’¨’´’∏’∂ ’§÷Ä’°’¥",
      unit_FX == "’¥’¨’∂ ‘±’Ñ’Ü ’§’∏’¨’°÷Ä" ~ "’¥’¨÷Ä’§ ‘±’Ñ’Ü ’§’∏’¨’°÷Ä",
    ),
  ) |> 
  ungroup() |> 
  mutate(
    indicator = fct_rev(indicator),
    unit_FX = fct_rev(unit_FX),
  ) |> 
  ggplot(aes(date, value, fill = indicator, label = text_correcton)) +
  geom_area() +
  geom_text(
    position = position_stack(vjust = .5)
    ) +
  facet_wrap(~unit_FX, scales = "free_y") +
  # facet_grid(unit_FX~indicator, scales = "free_y") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = number_format(accuracy = 1)) +
  scale_fill_manual(values = colfunc3(10)[c(8, 1)]) +
  labs(
    x = NULL,
    y = NULL,
    fill = NULL,
    title = "’Ä’Ä ’∫’•’ø’°’Ø’°’∂ ’∫’°÷Ä’ø÷Ñ",
    subtitle = "’Ü’•÷Ä÷Ñ’´’∂ ÷á ’°÷Ä’ø’°÷Ñ’´’∂ ’∫’°÷Ä’ø÷Ñ’´ ’∞’°÷Ä’°’¢’•÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’® ’Ä’Ä ’§÷Ä’°’¥’∏’æ ÷á ’°÷Ä’ø’°÷Ä’™’∏÷Ç’µ’©’∏’æ*",
    caption = caption_f("cba.am", suffix_text = "2024 ’©’æ’°’Ø’°’∂’´ ’ø’æ’µ’°’¨’∂’•÷Ä’® ’¥’°’µ’´’Ω ’°’¥’Ω’æ’° ’Ø’ø÷Ä’æ’°’Æ÷Ñ’∏’æ")
  )

```

```{r dept plot 3, include=FALSE}

dept_plot_3 <- 
  dept_clean |> 
  filter(
    grepl("AMD", code), 
    !grepl("Dept", code),
    grepl("[A-Z]{3}\\.1\\.\\d\\.\\d", code),
    # value != 0
  ) |>
  mutate(
    dept_posstion = ifelse(
      str_replace(code, "AMD.1.(\\d).\\d.", "\\1") == 1,
      "’°÷Ä’ø’°÷Ñ’´’∂ ’∫’°÷Ä’ø÷Ñ",
      "’∂’•÷Ä÷Ñ’´’∂ ’∫’°÷Ä’ø÷Ñ"
    ),
    indicator = str_trunc(indicator, 60),
    indicator = fct_inorder(indicator)
  ) |> 
  arrange(desc(dept_posstion), code) |> 
  mutate(indicator = fct_inorder(indicator)) |> 
  group_by(date) |> 
  mutate(pct = value / sum(value) * 1000) |> 
  ungroup() |> 
  pivot_longer(c(value, pct)) |> 
  mutate(name = fct_rev(name)) |> 
  ggplot(aes(date, value, fill = indicator)) +
  geom_area() +
  facet_grid(
    name ~ ., scales = "free_y", space = "free", 
    labeller = as_labeller(c(value = "’¥’¨÷Ä’§ ’§÷Ä’°’¥", pct = "’Ø’∑’´’º"))
  ) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(
    labels = function(x) {
      if(max(x, na.rm = TRUE) > 1000) {  # For the value facet
        number(x, big.mark = " ")
      } else {  # For the percentage facet
        percent(x/1000, accuracy = 1)
      }
    },
    breaks = breaks_pretty(n = 4)
  ) +
  scale_fill_manual(
    values = colfunc3(10)[c(10:7, 1:5)]
  ) +
  guides(fill = guide_legend(nrow = 4)) +
  labs(
    x = NULL,
    y = NULL,
    fill = NULL,
    title = "’ä’•’ø’°’Ø’°’∂ ’∫’°÷Ä’ø÷Ñ’´ ’Ø’°’º’∏÷Ç÷Å’æ’°’Æ÷Ñ’∂ ’®’Ω’ø ’∂’•÷Ä÷Ñ’´’∂ ÷á ’°÷Ä’ø’°÷Ñ’´’∂ ’∫’°÷Ä’ø÷Ñ’´ ’ø’•’Ω’°’Ø’∂’•÷Ä’´",
    subtitle = "’¢’°’µ÷Å ’•÷Ä’°’£’∂’•÷Ä’∏’æ ’∫’°’ø’Ø’•÷Ä’æ’°’Æ ’ß ’∂’•÷Ä÷Ñ’´’∂ ’∫’°÷Ä’ø÷Ñ’®, ’¥’∏÷Ç’£ ’•÷Ä’°’∂’£’•’∂÷Ä’∏’æ’ù ’°÷Ä’ø’°÷Ñ’´’∂",
    caption = caption_f("cba.am")
  )

```



***English summary below.***

’Ä’°÷Ä’£’•’¨’´ ’£’∏÷Ä’Æ’®’∂’Ø’•÷Ä,

’Ä’∏÷Ç’Ω’∏’æ ’•’¥’ù ’¨’°’æ ’•÷Ñ: 
’Ü’•÷Ä’Ø’°’µ’°÷Å’∂’∏÷Ç’¥ ’•’¥ ’°’µ’Ω ’∑’°’¢’°’©’æ’° ’æ’•÷Ä’¨’∏÷Ç’Æ’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’® ÷á ’°’∑’≠’°’ø’°’∂÷Ñ’∂’•÷Ä’®.

## [üåÖüèñüåÑ ](https://www.tvyal.com/newsletter/2024/2024_06_28)





**‘≥’Æ’°’∫’°’ø’Ø’•÷Ä 1.**

```{r, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 8}
dept_plot_1
```





**‘≥’Æ’°’∫’°’ø’Ø’•÷Ä 2.** 

```{r, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 8}
dept_plot_2
```




**‘≥’Æ’°’∫’°’ø’Ø’•÷Ä 3.**  

```{r, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 8}
dept_plot_3
```


**‘≥’Æ’°’∫’°’ø’Ø’•÷Ä 4.**

```{r, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 8}

```




**‘≥’Æ’°’∫’°’ø’Ø’•÷Ä 5.**

```{r, echo=FALSE, warning=FALSE, fig.width = 12, fig.height = 8}

```



>
> ’Å’•’¶ ’Ø’°÷Ä’∏’≤ ’•’∂ ’∞’•’ø’°÷Ñ÷Ä÷Ñ÷Ä’•’¨ ’∂’°÷á ’°’µ’Ω ’∂’µ’∏÷Ç’©’•÷Ä’®.
>
> * [üíº‚úàü•∂Ô∏è ’Ä’°’µ’°’Ω’ø’°’∂’´ ’∞’µ’∏÷Ç÷Ä’®’∂’Ø’°’¨’∏÷Ç’©’µ’°’∂ ’Ω’°’º’π’∏÷Ç’¥](https://www.tvyal.com/newsletter/2024/2024_04_21)÷â
> * [üí∏üîöüè¶ ‘ø’°’∫’´’ø’°’¨’´ ’°÷Ä’ø’°’∞’∏’Ω÷Ñ](https://www.tvyal.com/newsletter/2024/2024_03_01)÷â
>





-----

’Ä‘≥. ’Ä’°’¥’°’£’∏÷Ä’Æ’°’Ø÷Å’∏÷Ç’©’µ’°’∂ ’Ø’°’¥ ’°’ª’°’Ø÷Å’∏÷Ç’©’µ’°’∂ ’∞’°’¥’°÷Ä ’Ø’°÷Ä’∏’≤ ’•÷Ñ ’£÷Ä’•’¨ ’¥’•’¶÷â

‘µ’©’• ’∞’∂’°÷Ä’°’æ’∏÷Ä ’ß, ’≠’∂’§÷Ä’∏÷Ç’¥ ’•’¥ ’°’µ’Ω ’∂’µ’∏÷Ç’©’® ’∏÷Ç’≤’°÷Ä’Ø’•’¨ ’∂’°÷á ’°’µ’∂ ’¥’°÷Ä’§’Ø’°’∂÷Å, ’∏÷Ç’¥ ’°’µ’∂ ’Ø’°÷Ä’Æ’∏÷Ç’¥ ’•÷Ñ ’Ø’°÷Ä’∏’≤ ’ß ’∞’•’ø’°÷Ñ÷Ä÷Ñ÷Ä’•’¨:

’ç’∫’°’Ω’•÷Ñ ’∞’°’ª’∏÷Ä’§ ’∞’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’°’∂’® ’∞’°’ª’∏÷Ä’§ ’∏÷Ç÷Ä’¢’°’© ÷Ö÷Ä’®:     





## English Summary

### üåÖüèñüåÑ 



---

‘±’µ’Ω ’æ’•÷Ä’¨’∏÷Ç’Æ’∏÷Ç’©’µ’∏÷Ç’∂’® ’°’º’Ø’° ’ß ’∂’°÷á [’¥’•÷Ä ’Ø’°’µ÷Ñ’ß’ª’∏÷Ç’¥](https://www.tvyal.com/newsletter/2024/2024_06_28), ’°’µ’Ω ’æ’•÷Ä’¨’∏÷Ç’Æ’∏÷Ç’©’µ’°’∂ ’Ø’∏’§’® ÷á ’ø’æ’µ’°’¨’∂’•÷Ä’® ’§÷Ä’æ’°’Æ ’•’∂ ’∂’°÷á [Github-’∏÷Ç’¥](https://github.com/tavad/tvyal_newsletter)÷â       

---    

 


’Ä’°÷Ä’£’°’∂÷Ñ’∂’•÷Ä’∏’æ,            
‘±’≤’°’Ω’´ ‘π’°’æ’°’§’µ’°’∂         
28.06.2024          
[tvyal.com](https://www.tvyal.com/)      
[tavadyan.com](https://www.tavadyan.com/)

---

[Was this email forwarded to you? Subscribe here.](https://www.tvyal.com/subscribe)

[‘≤’°’™’°’∂’∏÷Ä’§’°’£÷Ä’æ’•÷Ñ](https://www.tvyal.com/subscribe)

       
---              
               


####### **’à÷Ç’∑’°’§÷Ä’∏÷Ç’©’µ’∏÷Ç’∂. ’Å’•÷Ä ’ß’¨.÷É’∏’Ω’ø’® ’¥’•’µ’¨’¨’´’Ω’©’´ ’¥’•’ª ’ß, ’∏÷Ä’´ ’¥’´’ª’∏÷Å’∏’æ ’•’Ω ’Ø’´’Ω’æ’∏÷Ç’¥ ’•’¥ ’∑’°’¢’°’©’°’Ø’°’∂ ’∂’µ’∏÷Ç’©’•÷Ä, ’∏÷Ä’∏’∂÷Ñ ’∞’´’¥’∂’°’Ø’°’∂’∏÷Ç’¥ ’∂’•÷Ä’Ø’°’µ’°÷Å’∂’∏÷Ç’¥ ’•’∂ ’Ä’°’µ’°’Ω’ø’°’∂’´ ’ø’∂’ø’•’Ω’∏÷Ç’©’µ’∏÷Ç’∂’®: ’Ü’µ’∏÷Ç’©’•÷Ä’® ’∂’•÷Ä’°’º’∏÷Ç’¥ ’•’∂ ’£’Æ’°’∫’°’ø’Ø’•÷Ä’∂’•÷Ä, [’ø’æ’µ’°’¨’∂’•÷Ä’´ ’¢’°’¶’°’∂’•÷Ä](https://github.com/tavad/tvyal_newsletter), ’ø’•’Ω’°’∂’µ’∏÷Ç’©’•÷Ä, ’∞’∏’§’æ’°’Æ’∂’•÷Ä, [’°’º÷Å’°’∂÷Å ’æ’°’∞’°’∂’°’Ø’∂’•÷Ä](https://www.tvyal.com/projects), ’ø’∂’ø’•’Ω’°’Ø’°’∂ ’£’∏÷Ä’Æ’´÷Ñ’∂’•÷Ä, ’Ø’°’∂’≠’°’ø’•’Ω’∏÷Ç’¥’∂’•÷Ä ÷á ’∞’°’∑’æ’•’ø’æ’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä: ‘µ’©’• ÷Å’°’∂’Ø’°’∂’∏÷Ç’¥ ’•÷Ñ ’π’•’≤’°÷Ä’Ø’•’¨ ’¢’°’™’°’∂’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®, ’≠’∂’§÷Ä’∏÷Ç’¥ ’•’¥ ’ø’•’≤’•’Ø’°÷Å÷Ä’•÷Ñ ’´’∂’±, ÷á ’•’Ω ’Ø’∞’•’º’°÷Å’∂’•’¥ ’±’•÷Ä ’ß’¨. ÷É’∏’Ω’ø’® ÷Å’∏÷Ç÷Å’°’Ø’´÷Å: ‘≥÷Ä’•÷Ñ ’∂’°÷á ’•’©’• ’∏÷Ç’∂’•÷Ñ ’¥’•’∂’Ø’∂’°’¢’°’∂’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä:**

####### **Important! Your email is part of the mailing list where I share weekly materials primarily focused on the Armenian economy. These materials encompass charts, [databases](https://github.com/tavad/tvyal_newsletter), videos, articles, [online dashboards](https://www.tvyal.com/projects), economic tools, forecasts, and reports. If you wish to unsubscribe, please let me know, and I will remove your email from the list. Please share your comments as well‚Ä§**







