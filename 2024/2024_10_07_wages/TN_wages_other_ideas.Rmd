---
title: "Tvyal Newsletter"
date: "2024-10-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(rvest)
library(RcppRoll)
library(scales)
library(readxl)
library(treemapify)

# rm(list = ls()); gc()

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

source("../../initial_setup.R")

```


```{r get raw data download, include=FALSE}

wages_raw <- 
  read_excel("wages_in_armenia_raw_2022.xlsx", skip = 2)

# # run the code below to update CPI data
# system(
#   paste0(
#     "curl \"", "https://www.cba.am/stat/stat_data_eng/6_CPI_eng.xls", "\"",
#     " -o ", "\"cpi_armenia_eng.xls\""
#   )
# )

inflation_raw <- read_excel("cpi_armenia_eng.xls", skip = 3)
workers_n <- read_excel("wages_more_info.xlsx", sheet = "workers_n")
public_wages <- read_excel("wages_more_info.xlsx", sheet = 3)

```


```{r data cleaning 3, include=FALSE}

max_year <- wages_raw |> colnames() |> parse_number() |> max(na.rm = TRUE)


inf_cumprod <-
  inflation_raw |>
  rename(date = 1, cpi_m = 2) |>
  select(date, cpi_m) |>
  mutate(
    date = ym(date),
    cpi_m = cpi_m / 100,
    year = year(date)
  ) |>
  filter(year <= max_year) |>
  mutate(
    cpi_yoy = roll_prodr(cpi_m, 12)
  ) |>
  arrange(desc(date)) |>
  mutate(
    adj_price = cumprod(cpi_m),
    adj_price = lag(adj_price),
    adj_price = ifelse(is.na(adj_price), 1, adj_price)
  ) |>
  group_by(year) |>
  filter(date == max(date)) |>
  ungroup() |>
  select(year, cpi_yoy, adj_price)


wages_clean <-
  wages_raw |>
  filter(!is.na(`2020`))  |>
  janitor::clean_names() |>
  mutate(
    across(matches("\\d{4}"), ~ifelse(.x == "-", NA, .x)),
    across(matches("\\d{4}"), ~ as.numeric(.x))
  ) |>
  mutate(
    indicator_arm = str_replace(indicator_arm, "աշխատավարձ, դրամ", "աշխատավարձ ՀՀ ընդհանուր, դրամ"),
    indicator_arm = str_remove(indicator_arm, "Միջին ամսական անվանական աշխատավարձը? ? ?-? ?\\(?"),
    indicator_arm = str_remove(indicator_arm, ", դրամ$"),
    indicator_arm = str_replace_all(indicator_arm, " *- *", " - "),

    indicator_eng = str_remove(indicator_eng, "Average monthly nominal wages? ? ?-? ?\\(? ?b?y? ?"),
    indicator_eng = str_replace_all(indicator_eng, " *- *", " - "),
  ) |>
  extract(
    indicator_arm, into = c("ind1_arm", "ind2_arm"),
    regex = "(ըստ .*) - (.*)", remove = FALSE
  ) |>
  extract(
    indicator_eng, into = c("ind1_eng", "ind2_eng"),
    regex = "(.*) - (.*)", remove = FALSE
  ) |>
  # extract(ind1_arm, into = c("ind1", "ind2"),
  #         regex = "(ըստ .*) *- *(.*)", remove = FALSE) |>
  # mutate(
  #   ind1 = ifelse(is.na(ind1), ind1_arm, ind1),
  #
  # ) |> view()
  mutate(
    correction_2017 = x2017_2 / x2017,
    correction_2012 = x2012_2 / x2012,
  ) |>
  select(-c(x2017_2, x2012_2)) |>
  pivot_longer(
    cols = matches("^x\\d{4}$"),
    names_to = "year", values_to = "wages"
  ) |>
  mutate(
    across(contains("ind"), ~str_trim(.x)),
    year = parse_number(year),
    wages_corrected = case_when(
      year <= 2012 & !is.na(correction_2017) ~ correction_2012 * correction_2017 * wages,
      year <= 2017 & year > 2012 & !is.na(correction_2017) ~ correction_2017 * wages,
      TRUE ~ wages
    )
  ) |>
  left_join(inf_cumprod, by = "year") |>
  mutate(wages_real = wages_corrected * adj_price) |>
  select(-contains("correction"))


rm(wages_raw, inflation_row)

```


```{r plot 1, include=FALSE, eval=FALSE}

wages_clean |>
  filter(grepl("RA Marzes and Yerevan", indicator_eng)) |>
  mutate(
    ind1_arm = case_when(
      grepl("ոչ պետական", ind1_arm) ~ "ոչ պետական",
      grepl("պետական", ind1_arm) ~ "պետական",
      TRUE ~ "ընդհանուր"
    ),
    ind1_eng = case_when(
      grepl("Non - Public", ind1_eng) ~ "Non-Public",
      grepl("Public", ind1_eng) ~ "Public",
      TRUE ~ "Total"
    ),
    ind2_eng = fct_relevel(ind2_eng, "Yerevan"),
    ind2_arm = fct_relevel(ind2_arm, "ք. Երևան")
  ) |>
  ggplot(aes(year, wages_real / 1000, fill = year)) +
  geom_col() +
  facet_grid(ind1_eng ~ ind2_eng) +
  scale_y_continuous(breaks = seq(0, 1000, 100), labels = comma_format()) +
  scale_x_continuous(labels = NULL, breaks = NULL) +
  scale_fill_gradient(breaks = 2008:2020,  high = "#2f4b7c", low = "#f95d6a") +
  labs(
    x = NULL,
    y = NULL,
    title = "Ամսական իրական միջին աշխատավարձը ըստ մարզերի Հայաստանում",
    subtitle = "հազար դրամ, գաճով ճշգրտված"
  ) +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(2.5, 'cm'),
    legend.box =
  )

```


```{r main 2, include=FALSE}

 # provide 2 consecutive years that are in wages_clean
years_select = c(max_year - 1, max_year)

date_legend <-
  tibble(
    x = 215, y = c(1.5, 2.5),
    color = c("#2f4b7c", "#f95d6a"),
    text = rev(years_select),
    ind1_arm = "պետական",
    ind1_eng = "Public"
  )


wages_change_2021_22_plot <-
  wages_clean |>
  filter(grepl("RA Marzes and Yerevan", indicator_eng)) |>
  mutate(
    ind1_arm = case_when(
      grepl("ոչ պետական", ind1_arm) ~ "ոչ պետական",
      grepl("պետական", ind1_arm) ~ "պետական",
      TRUE ~ "ընդհանուր"
    ),
    ind1_eng = case_when(
      grepl("Non - Public", ind1_eng) ~ "Non-Public",
      grepl("Public", ind1_eng) ~ "Public",
      TRUE ~ "Total"
    ),
    # ind2_eng = fct_relevel(ind2_eng, "Yerevan"),
    # ind2_arm = fct_relevel(ind2_arm, "ք. Երևան")
  ) |>
  filter(year %in% years_select) |>
  select(ind1_arm, ind2_arm, ind1_eng, ind2_eng, year, wages_real) |>
  mutate(
    wages_real = wages_real / 1000,
    year = ifelse(year == min(year), "begining", "end")
  ) |>
  rename(marz_arm = ind2_arm, marz_eng = ind2_eng) |>
  pivot_wider(names_from = year, values_from = wages_real) |>
  mutate(
    marz_arm = fct_reorder(marz_arm, (begining + end)/2, .fun = mean),
    marz_eng = fct_reorder(marz_eng, (begining + end)/2, .fun = mean),
    color = ifelse(begining > end, "#f95d6a", "#2f4b7c"),
    ind1_eng = factor(ind1_eng, levels = c("Total", "Non-Public", "Public"))
  ) |>
  ggplot() +
  facet_grid(~ind1_eng, scales = "free_x", space = "free_x") +
  geom_segment(
    aes(x = begining, xend = end,  y = marz_eng,
        yend = marz_eng, group = ind1_eng, color = I(color)),
    linewidth = 1.2,
    lineend = "round", linejoin = "round",
    arrow = arrow(length = unit(0.1, "inches"))
  ) +
  geom_point(aes(x=begining, y=marz_eng, color=I("#f95d6a")), size = 3) +
  geom_point(aes(x=end, y=marz_eng, color=I("#2f4b7c")), size = 3) +
  geom_point(data = date_legend, aes(x, y, color = I(color)), size = 3) +
  geom_text(data = date_legend, aes(x + 15, y, label = text)) +
  scale_y_discrete() +
  labs(
    x = NULL,
    y = NULL,
    color = NULL,
    # title = "Միջին ամսական անվանական աշխատավարձը ըստ մարզերի և տնտեսության հատվածների",
    # subtitle = "Ներկայացված են իրական աշխատավարձերը, 2022 թվականի 8.3 տոկոս գնաճով ճշգրտված\nհազար ՀՀ դրամ",
    # caption = paste0(caption_arm, "    |    տվյալների աղբյուր` armstat.am")
    title = "Average monthly salary by regions and sectors of the economy",
    subtitle = "Real nominal salaries, thousand AMD, 2021 is adjusted by 8.3% inflation in 2022",
    caption = paste0(caption_eng, "    |    Data Source: armstat.am")
  )


```


```{r plots 32,  include=FALSE, eval=FALSE}

wages_by_sector <-
  wages_clean |>
  mutate(
    ind2_arm = str_trunc(ind2_arm, 30),
    ind2_eng = str_trunc(ind2_eng, 30)
  ) |>
  filter(year %in% years_select) |>
  select(ind1_arm, ind2_arm, ind1_eng, ind2_eng, year, wages_real) |>
  mutate(
    wages_real = wages_real / 1000,
    year = ifelse(year == min(year), "begining", "end")
  ) |>
  pivot_wider(names_from = year, values_from = wages_real) |>
  mutate(
    ind2_arm = fct_reorder(ind2_arm, (begining + end)/2, .fun = mean),
    ind2_eng = fct_reorder(ind2_eng, (begining + end)/2, .fun = mean),
    color = ifelse(begining > end, "#f95d6a", "#2f4b7c")
  ) |>
  ggplot() +
  geom_segment(
    aes(x = begining, xend = end,  y = ind2_eng,
        yend = ind2_eng, group = ind1_eng, color = I(color)),
    linewidth = 1.2,
    lineend = 'round', linejoin = 'round',
    arrow = arrow(length = unit(0.1, "inches"))
  ) +
  geom_point(aes(x = begining, y = ind2_eng, color = I("#f95d6a")), size = 3) +
  geom_point(aes(x = end, y = ind2_eng, color = I("#2f4b7c")), size = 3) +
  geom_point(data = date_legend, aes(x + 400, y, color = I(color)), size = 3) +
  geom_text(data = date_legend, aes(x + 480, y, label = text)) +
  scale_x_log10(breaks = seq(0, 800, 100), limits =c(100, 800)) +
  scale_y_discrete() +
  labs(
    x = NULL,
    y = NULL,
    color = NULL,
    # title = "Միջին ամսական աշխատավարձը ըստ տնտեսական գործունեության",
    # subtitle = "Ներկայացված են իրական աշխատավարձերը, 2022 թվականի 8.3 տոկոս գնաճով ճշգրտված\nանվանական, հազար ՀՀ դրամ",
    # caption = paste0(caption_arm, "    |    տվյալների աղբյուր` armstat.am")
    title = "Average Monthly Salary by Economic Activity",
    subtitle = "Real nominal salaries, thousand AMD, 2021 is adjusted by 8.3% inflation in 2022",
    caption = paste0(caption_eng, "    |    Data Source: armstat.am")
  )

```










```{r main 3, include=FALSE}

 # provide 2 consecutive years that are in wages_clean
years_select = c(max_year - 1, max_year)

date_legend <-
  tibble(
    x = 215, y = c(1.5, 2.5),
    color = c("#2f4b7c", "#f95d6a"),
    text = rev(years_select),
    ind1_arm = "պետական",
    ind1_eng = "Public"
  )


wages_change_2021_22_plot <-
  wages_clean |>
  filter(grepl("RA Marzes and Yerevan", indicator_eng)) |>
  mutate(
    ind1_arm = case_when(
      grepl("ոչ պետական", ind1_arm) ~ "ոչ պետական",
      grepl("պետական", ind1_arm) ~ "պետական",
      TRUE ~ "ընդհանուր"
    ),
    ind1_eng = case_when(
      grepl("Non - Public", ind1_eng) ~ "Non-Public",
      grepl("Public", ind1_eng) ~ "Public",
      TRUE ~ "Total"
    ),
    # ind2_eng = fct_relevel(ind2_eng, "Yerevan"),
    # ind2_arm = fct_relevel(ind2_arm, "ք. Երևան")
  ) |>
  filter(year %in% years_select) |>
  select(ind1_arm, ind2_arm, ind1_eng, ind2_eng, year, wages_real) |>
  mutate(
    wages_real = wages_real / 1000,
    year = ifelse(year == min(year), "begining", "end")
  ) |>
  rename(marz_arm = ind2_arm, marz_eng = ind2_eng) |>
  pivot_wider(names_from = year, values_from = wages_real) |>
  mutate(
    marz_arm = fct_reorder(marz_arm, (begining + end)/2, .fun = mean),
    marz_eng = fct_reorder(marz_eng, (begining + end)/2, .fun = mean),
    color = ifelse(begining > end, "#f95d6a", "#2f4b7c"),
    ind1_eng = factor(ind1_eng, levels = c("Total", "Non-Public", "Public"))
  ) |>
  ggplot() +
  facet_grid(~ind1_eng, scales = "free_x", space = "free_x") +
  geom_segment(
    aes(x = begining, xend = end,  y = marz_eng,
        yend = marz_eng, group = ind1_eng, color = I(color)),
    linewidth = 1.2,
    lineend = "round", linejoin = "round",
    arrow = arrow(length = unit(0.1, "inches"))
  ) +
  geom_point(aes(x=begining, y=marz_eng, color=I("#f95d6a")), size = 3) +
  geom_point(aes(x=end, y=marz_eng, color=I("#2f4b7c")), size = 3) +
  # geom_point(data = date_legend, aes(x, y, color = I(color)), size = 3) +
  # geom_text(data = date_legend, aes(x + 15, y, label = text)) +
  scale_x_continuous(breaks = seq(50, 600, 50)) +
  scale_y_discrete() +
  labs(
    x = NULL,
    y = NULL,
    color = NULL,
    # title = "Միջին ամսական անվանական աշխատավարձը ըստ մարզերի և տնտեսության հատվածների",
    # subtitle = "Ներկայացված են իրական աշխատավարձերը, 2022 թվականի 8.3 տոկոս գնաճով ճշգրտված\nհազար ՀՀ դրամ",
    # caption = paste0(caption_arm, "    |    տվյալների աղբյուր` armstat.am")
    title = "Average monthly salary by regions and sectors of the economy",
    subtitle = "Real nominal salaries, thousand AMD, 2021 (red) is adjusted by 8.3% inflation in 2022 (blue)",
    caption = paste0(caption_eng, "    |    Data Source: armstat.am")
  )
  # theme(
  #   panel.grid.major.y = element_blank()
  # )


```


```{r plots 3,  include=FALSE}

wages_by_sector <-
  wages_clean |>
  filter(grepl("Types of Economic Activity", indicator_eng)) |>
  mutate(
    ind2_arm = str_trunc(ind2_arm, 30),
    ind2_eng = str_trunc(ind2_eng, 30)
  ) |>
  filter(year %in% years_select) |>
  select(ind1_arm, ind2_arm, ind1_eng, ind2_eng, year, wages_real) |>
  mutate(
    wages_real = wages_real / 1000,
    year = ifelse(year == min(year), "begining", "end")
  ) |>
  pivot_wider(names_from = year, values_from = wages_real) |>
  mutate(
    ind2_arm = fct_reorder(ind2_arm, (begining + end)/2, .fun = mean),
    ind2_eng = fct_reorder(ind2_eng, (begining + end)/2, .fun = mean),
    color = ifelse(begining > end, "#f95d6a", "#2f4b7c")
  ) |>
  ggplot() +
  geom_segment(
    aes(x = begining, xend = end,  y = ind2_eng,
        yend = ind2_eng, group = ind1_eng, color = I(color)),
    linewidth = 1.2,
    lineend = 'round', linejoin = 'round',
    arrow = arrow(length = unit(0.1, "inches"))
  ) +
  geom_point(aes(x = begining, y = ind2_eng, color = I("#f95d6a")), size = 3) +
  geom_point(aes(x = end, y = ind2_eng, color = I("#2f4b7c")), size = 3) +
  geom_point(data = date_legend, aes(x + 400, y, color = I(color)), size = 3) +
  geom_text(data = date_legend, aes(x + 480, y, label = text)) +
  scale_x_log10(breaks = seq(0, 800, 100), limits =c(100, 800)) +
  scale_y_discrete() +
  labs(
    x = NULL,
    y = NULL,
    color = NULL,
    # title = "Միջին ամսական աշխատավարձը ըստ տնտեսական գործունեության",
    # subtitle = "Ներկայացված են իրական աշխատավարձերը, 2022 թվականի 8.3 տոկոս գնաճով ճշգրտված\nանվանական, հազար ՀՀ դրամ",
    # caption = paste0(caption_arm, "    |    տվյալների աղբյուր` armstat.am")
    title = "Average Monthly Salary by Economic Activity",
    subtitle = "Real nominal salaries, thousand AMD, 2021 is adjusted by 8.3% inflation in 2022",
    caption = paste0(caption_eng, "    |    Data Source: armstat.am")
  )

```








```{r not run, include=FALSE, warning=FALSE, eval=FALSE}
wages_clean |>
  filter(grepl("ըստ կազմակերպության չափի", indicator_arm)) |>
  mutate(
    ind1_arm = case_when(
      grepl("ոչ պետական", ind1_arm) ~ "ոչ պետական",
      grepl("պետական", ind1_arm) ~ "պետական",
      TRUE ~ "ընդհանուր"
    ),
    ind1_arm = fct_reorder(ind1_arm, wages_real, .desc = TRUE),
    ind2_arm = str_remove(ind2_arm, "ում$")
  ) |>
  ggplot(aes(year, wages_real / 1000, color = ind1_arm)) +
  geom_line(linewidth = 1.5) +
  facet_wrap(~ind2_arm, scale = "free_y") +
  scale_x_continuous(breaks = seq(2008, 2030, 2)) +
  scale_color_manual(values = new_palette_colors[c(2,6,8)]) +
  labs(
    x = NULL,
    y = NULL,
    color = NULL,
    title = "Միջին ամսական անվանական աշխատավարձը ըստ կազմակերպության չափի",
    subtitle = "Ներկայացված են իրական աշխատավարձերը, 2022 թվականի 8.3 տոկոս գնաճով ճշգրտված\nհազար ՀՀ դրամ",
    caption = paste0(caption_arm, "    |    տվյալների աղբյուր` armstat.am")
  )


wages_clean |>
  filter(
    grepl("ՀՀ ընդհանուր|ըստ սեռի", indicator_arm),
    !grepl( "նվազագույն", indicator_arm)
  ) |>
  mutate(
    indicator_arm = ifelse(is.na(ind1_arm), indicator_arm, ind2_arm),
    indicator_arm = fct_reorder(indicator_arm, wages_real, .desc = TRUE),
  ) |>
  ggplot(aes(year, wages_real / 1000, color = indicator_arm)) +
  geom_line(linewidth = 1.5) +
  scale_x_continuous(breaks = seq(2008, 2030, 2)) +
  scale_color_manual(values = new_palette_colors[c(2,6,8)]) +
  labs(
    x = NULL,
    y = NULL,
    color = NULL,
    title = "Միջին ամսական անվանական աշխատավարձը ըստ սեռի",
    subtitle = "Ներկայացված են իրական աշխատավարձերը, 2022 թվականի 8.3 տոկոս գնաճով ճշգրտված\nհազար ՀՀ դրամ",
    caption = paste0(caption_arm, "    |    տվյալների աղբյուր` armstat.am")
  )
```











```{r}
wages_db_clean <- read_csv("wages_db_clean.csv")
  
wages_db_clean |> 
  filter(
nace_2_code == "G" & date %in% ymd("2023-11-30", "2023-12-31", "2024-01-31", "2024-02-29", "2024-03-31") & type_eng == "Non-public"
)

inf_cumprod <- 
  inflation_row |> 
  rename(date = 1, cpi_m = 2) |> 
  select(date, cpi_m) |> 
  mutate(
    date = ym(date) + months(1) - days(1),
    cpi_m = cpi_m / 100,
    year = year(date)
  ) |> 
  filter(date <= max(wages_db_clean$date)) |>
  select(-year) |> 
  arrange(desc(date)) |> 
  mutate(
    adj_price = cumprod(cpi_m),
    adj_price = lag(adj_price),
    adj_price = ifelse(is.na(adj_price), 1, adj_price)
  )
```



```{r}
library(cNORM)




calculate_weighted_deciles <- function(wages, weights, probs = seq(0.1, 0.9, 0.1), ...) {
  deciles <- weighted.quantile(x = wages, probs = probs, weights = weights, ...)
  return(deciles)
}


# Calculate wage deciles by month
# wages_db_clean |> count(type_eng)

wage_deciles <- 
  wages_db_clean %>%
  filter(
    !is.na(wages_cumulative) & !is.na(employees),
    nace_2_code %in% LETTERS,
  ) %>%
  group_by(date, type_eng) %>%
  # summarise(deciles = list(calculate_weighted_deciles(wages_cumulative, employees))) |> 
  reframe(
    deciles = paste0("Decile ", 1:9),
    wages = calculate_weighted_deciles(wages_cumulative, employees)
  )

wage_deciles |> 
  pivot_wider(names_from = deciles, values_from = wages)


wage_deciles |> 
  filter(
    # type_eng == "Public"
    type_eng == "Total",
    # type_eng == "Non-public",
  ) |> 
  left_join(inf_cumprod, join_by(date)) |> 
  # filter(!date %in% ymd("2022-12-31", "2024-01-31")) |> 
  mutate(
    # wages = wages * adj_price,
    label_text = ifelse(date == max(date), deciles, NA)
  ) |>
  ggplot(aes(date, wages / 1000 , color = deciles, label = label_text)) +
  geom_line(linewidth = 1, alpha = 1) +
  geom_text(hjust = -0.2) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(breaks = (1:10)*100) +
  scale_color_manual(values = rev(colfunc2(9))) +
  coord_cartesian(clip = "off") +
  labs(
    x = NULL,
    y = NULL,
    color = NULL,
    title = "Որքա՞ն է աշխատողների ամսական եկամուտը Հայաստանում",
    # subtitle = "Աշխատավարձերի փոփոխությունը եկամտային հարկումից առաջ ըստ դեցիլների\nաշխատավարձերը ճշգրտվել են 2024 թվականի օգոստոսի գներով և կշռվել",
    subtitle = "Աշխատավարձերի փոփոխությունը եկամտային հարկումից առաջ ըստ դեցիլների",
    caption = caption_arm
  ) +
  theme(
    panel.grid.major.x = element_blank(),
    legend.position = "none",
    plot.margin = margin(10, 30, 10, 10)
  )

  
# Display the results
# print(wage_deciles) |> view()
```

```{r}

wage_quantile <- 
  wages_db_clean |> 
  filter(
    !is.na(wages_cumulative) & !is.na(employees),
    nace_2_code %in% LETTERS,
  ) |> 
  group_by(date, type_eng) |> 
  # summarise(deciles = list(calculate_weighted_deciles(wages_cumulative, employees))) |> 
  reframe(
    deciles = c("mean", paste0("Q", 1:3), "D99"),
    wages = c(
      sum(wages_cumulative * employees) / sum(employees),
      weighted.quantile(x = wages_cumulative, probs = c(0.25, 0.5, 0.75, 0.99), weights = employees)
    )
  ) |> 
  mutate(
    deciles = factor(deciles, levels = c("Q1", "Q2", "mean", "Q3")) |> fct_rev()
  ) |> 
  arrange(deciles)


wage_quantile |> 
  filter(
    # type_eng == "Public"
    type_eng == "Total",
    # type_eng == "Non-public",
  ) |> 
  left_join(inf_cumprod, join_by(date)) |> 
  # filter(!date %in% ymd("2022-12-31", "2024-01-31")) |> 
  mutate(
    wages = wages * adj_price,
    
    deciles_name_arm = case_when(
      deciles == "Q1" ~ "Q1 (ամենացածր 25% շեմ)",
      deciles == "Q2" ~ "մեդիան աշխատավարձ (Q2)",
      deciles == "Q3" ~ "Q3 (ամենաբարձր 25% շեմ)",
      deciles == "mean" ~ "միջին աշխատավարձ",
    ),
    label_text = ifelse(date == max(date), deciles_name_arm, NA),
    label_text = fct_inorder(label_text)
  ) |>
  ggplot(aes(date, wages / 1000 , color = deciles, label = label_text)) +
  geom_line(linewidth = 1, alpha = 1) +
  geom_text(hjust = 0.5, vjust = -1) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(n.breaks = 8) +
  scale_color_manual(values = new_palette_colors[c(2,4,6,8)]) +
  coord_cartesian(clip = "off") +
  labs(
    x = NULL,
    y = NULL,
    color = NULL,
    title = "Որքա՞ն է աշխատողների ամսական եկամուտը Հայաստանում",
    subtitle = "Աշխատավարձերի փոփոխությունը եկամտային հարկումից առաջ\nԱշխատավարձերը ճշգրտվել են 2024թ․ օգուստոսի գնողունակությամբ",
    # subtitle = "Աշխատավարձերի փոփոխությունը եկամտային հարկումից առաջ",
    caption = caption_arm
  ) +
  theme(
    panel.grid.major.x = element_blank(),
    legend.position = "none",
    plot.margin = margin(10, 60, 10, 10)
  )

```

```{r}

wage_quantile |> 
  filter(
    # type_eng == "Public"
    type_eng != "Total",
    # type_eng == "Non-public",
  ) |> 
  left_join(inf_cumprod, join_by(date)) |> 
  # filter(!date %in% ymd("2022-12-31", "2024-01-31")) |> 
  mutate(
    # wages = wages * adj_price,
    
    deciles_name_arm = case_when(
      deciles == "Q1" ~ "Q1 (ամենացածր 25% շեմ)",
      deciles == "Q2" ~ "մեդիան աշխատավարձ (Q2)",
      deciles == "Q3" ~ "Q3 (ամենաբարձր 25% շեմ)",
      deciles == "mean" ~ "միջին աշխատավարձ",
    ),
    label_text = ifelse(date == max(date), deciles_name_arm, NA),
    label_text = fct_inorder(label_text),
    deciles_name_arm = fct_inorder(deciles_name_arm),
    type_eng = case_when(
      type_eng == "Public" ~ "Պետական",
      type_eng == "Total" ~ "Ընդհանուր",
      type_eng == "Non-public" ~ "Մասնավոր"
    )
  ) |>
  ggplot(aes(date, wages / 1000 , color = deciles_name_arm, label = label_text)) +
  geom_line(linewidth = 1, alpha = 1) +
  # geom_text(hjust = 0.5, vjust = -1) +
  facet_wrap(~type_eng) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(n.breaks = 8) +
  scale_color_manual(values = new_palette_colors[c(2,4,6,8)]) +
  coord_cartesian(clip = "off") +
  labs(
    x = NULL,
    y = NULL,
    color = NULL,
    title = "Որքա՞ն է աշխատողների ամսական եկամուտը Հայաստանում",
    # subtitle = "Աշխատավարձերի փոփոխությունը եկամտային հարկումից առաջ\nԱշխատավարձերը ճշգրտվել են 2024թ․ օգուստոսի գնողունակությամբ",
    subtitle = "Աշխատավարձերի փոփոխությունը եկամտային հարկումից առաջ",
    caption = caption_arm
  ) +
  theme(
    panel.grid.major.x = element_blank(),
    # legend.position = "none",
    plot.margin = margin(10, 60, 10, 10)
  )

```


```{r}
wage_1000 <- 
  wages_db_clean %>% 
  filter(
    !is.na(wages_cumulative) & !is.na(employees),
    nace_2_code %in% LETTERS,
    type_eng != "Total"
  ) %>% 
  group_by(date) %>%
  # summarise(deciles = list(calculate_weighted_deciles(wages_cumulative, employees))) |> 
  reframe(
    deciles = paste0("P", 1:999),
    wages = calculate_weighted_deciles(wages_cumulative, employees, probs = seq(0.001,0.999,0.001))
  )

wage_1000 |>
  filter(date == max(date)) |> 
  ggplot(aes(wages)) +
  geom_density()



wage_group_percentages
wage_1000 %>%
  mutate(
    income_bin = cut(
      wages/1000,
      breaks = c(0, 110, 125, 150, 200, 250, 300, 400, 1e6),
      include.lowest = TRUE
    )
  ) |> 
  group_by(date) |> 
  count(income_bin) |> 
  pivot_wider(names_from = income_bin, values_from = n) |> 
  relocate(date, `[0,110]`) |> 
  view()


  group_by(date) %>%
  # Use employees as weights
  count(date, income_bin, wt = employees) %>%
  group_by(date) %>%
  mutate(
    pct = n / sum(n),
    lower_cut = as.numeric(sub("\\((.+),.*", "\\1", income_bin)),
    upper_cut = as.numeric(sub("[^,]*,([^]]*)\\]", "\\1", income_bin))
  ) %>%
  mutate(
    label = case_when(
      lower_cut == 0 ~ paste0(upper_cut, " drams or less"),
      upper_cut == Inf ~ paste0(lower_cut, " drams or more"),
      TRUE ~ paste0(lower_cut, " to ", upper_cut, " drams")
    )
  ) %>%
  arrange(lower_cut) %>%
  mutate(
    label = factor(label, levels = unique(label)),
    label = fct_rev(label),
    # pct_text = ifelse(pct <= 0.01, NA, percent(pct, accuracy = 0.1))
  ) %>%
  select(date, label, pct) |> 
  # pivot_wider(names_from = label, values_from = c(pct), names_glue = "{label}_{.value}") |> 
  # view()


```


```{r}
library(moments)  # for weighted.mean and weighted.sd


# Calculate log-normal parameters by date
lognormal_params <- 
  wages_db_clean |> 
  filter(
    !is.na(wages_cumulative) & !is.na(employees) & wages_cumulative > 0,
    nace_2_code %in% LETTERS,
    type_eng == "Total"
    # type_eng == "Non-public",
    # type_eng == "Public"
  ) |> 
  left_join(inf_cumprod, by = "date") |> 
  mutate(
    wages_cumulative = wages_cumulative * adj_price,  # comment out to see adjusted wages
    log_wages = log(wages_cumulative)
  ) |> 
  rename(weights = employees) |> 
  group_by(date) |> 
  summarise(
    mean = weighted.mean(log_wages, weights),
    sd = sqrt(weighted.mean((log_wages - mean)^2, weights)),
    .groups = "drop"
  )

lognormal_params |> 
  rowwise() |> 
  mutate(
    deciles = list(setNames(
      exp(qnorm(seq(0.1, 0.9, 0.1), mean, sd)),
      paste0("D", seq(10, 90, 10))
    ))
  ) |> 
  ungroup() |> 
  unnest_wider(deciles)

  

  

# Define wage groups
wage_groups <- c(0, 100, 125, 150, 200, 250, 300, 400, 500, Inf)*1000
group_labels <- sapply(seq_along(wage_groups)[-1], function(i) {
  lower <- wage_groups[i-1] / 1000
  upper <- wage_groups[i] / 1000
  if (is.infinite(upper)) {
    return(str_glue("{lower}k+       "))
  } else if (lower == 0) {
    return(str_glue("<{upper}k       "))
  } else {
    return(str_glue("{lower}k-{upper}k"))
  }
})

# Calculate probabilities for each wage group
wage_group_probabilities <- lognormal_params %>%
  mutate(
    probabilities = pmap(list(mean, sd), function(m, s) {
      probs <- diff(plnorm(wage_groups, meanlog = m, sdlog = s))
      setNames(probs, group_labels)
    })
  ) %>%
  unnest_wider(probabilities)

# wage_group_probabilities |> view()

# Format the results
wage_group_probabilities_formatted <- wage_group_probabilities %>%
  pivot_longer(cols = all_of(group_labels), names_to = "wage_group", values_to = "probability") %>%
  select(date, wage_group, probability)

# Display the results
print(wage_group_probabilities_formatted)

colfunc_4 <- colorRampPalette(c("#2f4b7c", "gray50", "#f95d6a"))


wage_group_probabilities_formatted |> 
  mutate(
    year = lubridate::year(date),
    label = factor(wage_group, levels = unique(wage_group)),
    label = fct_rev(label)
  ) %>%
  group_by(year) |> 
  mutate(
    formatted_pct = ifelse(probability <= 0.01 | month(date) != 12, NA, percent(probability, accuracy = 0.1)),
  ) |> 
  ungroup() |> 
  mutate(label_text = ifelse(date == max(date), wage_group, NA)) |> 
  ggplot(aes(date, probability, fill = label)) +
  geom_area(alpha = 1, color = "gray30") +
  geom_text(aes(label = formatted_pct), position = position_stack(vjust = 0.5), size = 3) +
  geom_text(aes(label = label_text, color = label), position = position_stack(vjust = 0.5), hjust = -0.15, size = 4) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_fill_manual(values = colfunc(9)) +
  scale_color_manual(values = colfunc_4(9)) +
  coord_cartesian(clip = "off") +
  labs(
    x = NULL,
    y = NULL,
    fill = NULL,
    color = NULL,
    # title = "Wage Distribution in Armenia Over Time",
    # subtitle = "Percentage of employees in different wage groups by year*",
    # caption = caption_f(suffix_text = "Based on log-normal distribution estimates")
    title = "Ինչքա՞ն աշխատավարձ են ստանում Հայաստանում",
    subtitle = "Աշխատողների տոկոսը տարբեր աշխատավարձի խմբերում ըստ տարիների*\nԱշխատավարձերը ճշգրտվել են 2024թ․ օգուստոսի գնողունակությամբ",
    # subtitle = "Աշխատողների տոկոսը տարբեր աշխատավարձի խմբերում ըստ տարիների*",
    caption = caption_f(suffix_text = "Հաշվարկը հիմնված լոգարիթմական նորմալ բաշխման կշռված գնահատականների վրա")
  ) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "none",
    plot.margin = margin(10, 55, 10, 10),
    plot.title = element_text(hjust = 0.13),
    plot.subtitle = element_text(hjust = 0.13)
  )
```

```{r}

wages_test <- 
  wages_db_clean |> 
  filter(nace_2_code == "A-S", type_eng == "Total") |> 
  transmute(date, l_wages_cumulative = wages_cumulative)

lognormal_params |> 
  mutate(
    l_mean = exp(mean + (sd^2)/2),
    l_median = exp(mean),
    l_mode = exp(mean - sd^2)
  ) |> 
  left_join(wages_test, by = "date") |> 
  pivot_longer(
    contains("l_"), names_to = "central_tendances"
  ) |> 
  left_join(inf_cumprod, join_by(date)) |> 
  # filter(!date %in% ymd("2022-12-31", "2024-01-31")) |> 
  mutate(
    # value = value * adj_price
  ) |> 
  ggplot(aes(date, value, color = central_tendances)) +
  geom_line(size = 1, alpha = 1) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(n.breaks = 8) +
  scale_color_manual(values = new_palette_colors[c(2,4,6,8)]) +
  coord_cartesian(clip = "off") +
  labs(
    x = NULL,
    y = NULL,
    color = NULL,
    title = "central_tendances",
    subtitle = "Աշխատավարձերի փոփոխությունը եկամտային հարկումից առաջ ըստ դեցիլների\nաշխատավարձերը ճշգրտվել են 2024 թվականի օգոստոսի գներով և կշռվել",
    caption = caption_arm
  ) +
  theme(
    panel.grid.major.x = element_blank(),
    # legend.position = "none",
    plot.margin = margin(10, 60, 10, 10)
  )





```


## Նախորդ նյութի ճշգրտում իրավաբանական տեսանկյունից։

‼️
Մենք միշտ ձգտում ենք որ մեր կոզմից հրապարակվող աշխատությունները լինեն հնարավորինս օբյեկտիվ և ապաքաղաքական, որը միշտ չէ որ հաջողվում է։ Tvyal.com-ի արժեքների հիմքում է ճշմարտությունը և ճշգրտությունը։ Նախորդ նյութը հրապարակելիս [«📢✊🕊️ Թավշյա իրարանցում և կազմակերպական փոփոխություն»](https://www.tvyal.com/newsletter/2024/2024_10_14) առկա է մի կարևոր փաստարկի բացակայություն, որը նյութը գրելու պահին մեզ հասանելի չէր։ [2016թ. դեկտեմբերին վերացվեց «իրավաբանական անձանց միություն» (ԻԱՄ) կազմակերպաիրավական ձևը](https://www.arlis.am/DocumentView.aspx?docid=110836): Սահմանվեց, որ բոլոր նման կազմակերպությունները պետք է մեկ տարվա ընթացքում (մինչև 2017թ. վերջ) վերագրանցվեն որպես հասարակական կազմակերպություն (ՀԿ): Այս փաստարկը որոշակիօրեն, սակայն ոչ ամբողջությամբ բացատրում է ՀԿ-ների տարօրինակ աճը 2017-թ․ վերջին։ Կարևոր է նշել որ մինչև 2017թ. վերջ Հայաստանում գրանցված էր 347 ԻԱՄ, որը զգալիորեն փոքր է 2017թ. նոյեմբեր-դեկտեմբեր ամիսներին գրանցված 737 ՀԿ-ների թվից: Սա պահանջում է հետագա հավելյալ հետազոտություն, որը կներառի նաև գրանցված կազմակերպությունները ամբողջական շարքը Հայաստանի երրորդ հանրապետության ձևավորման սկզբից։ [Մանրամասները ավելացվել են տվյալ նյութի վերջում։](https://www.tvyal.com/newsletter/2024/2024_10_14)




